<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VistaView Agentic AI v32</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --teal:#003B32; --teal-light:#065f46; --gold:#B8860B; --gold-light:#F5EC9B; --success:#10b981; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',sans-serif; background:linear-gradient(180deg,#003B32,#002520,#001a15); color:#fff; min-height:100vh; }
        
        .header { display:flex; justify-content:space-between; align-items:center; padding:12px 20px; background:rgba(0,37,32,0.95); border-bottom:2px solid var(--gold); position:sticky; top:0; z-index:1000; }
        .logo-area { display:flex; align-items:center; gap:12px; }
        .logo { width:44px; height:44px; background:linear-gradient(135deg,var(--gold),var(--gold-light)); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:24px; }
        .brand h1 { font-size:1.3em; font-weight:800; }
        .brand h1 span { color:var(--gold); }
        .brand p { font-size:0.6em; color:var(--gold); letter-spacing:2px; text-transform:uppercase; }
        .status { display:flex; align-items:center; gap:8px; padding:6px 14px; background:rgba(16,185,129,0.15); border:1px solid rgba(16,185,129,0.4); border-radius:20px; font-size:0.75em; }
        .dot { width:8px; height:8px; background:var(--success); border-radius:50%; animation:pulse 2s infinite; }
        @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,0.7)} 50%{box-shadow:0 0 0 6px rgba(16,185,129,0)} }
        
        .voice-bar { margin:12px; background:linear-gradient(135deg,var(--teal-light),var(--teal)); border:2px solid var(--gold); border-radius:16px; padding:12px 16px; display:flex; align-items:center; gap:12px; }
        .mic { width:50px; height:50px; border-radius:50%; background:linear-gradient(135deg,var(--gold),var(--gold-light)); border:none; cursor:pointer; font-size:1.4em; display:flex; align-items:center; justify-content:center; transition:all 0.3s; flex-shrink:0; }
        .mic:hover { transform:scale(1.1); }
        .mic.on { background:linear-gradient(135deg,#ef4444,#f87171); animation:rec 1s infinite; }
        @keyframes rec { 0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.7)} 50%{box-shadow:0 0 0 10px rgba(239,68,68,0)} }
        .voice-content { flex:1; }
        .voice-head { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
        .voice-title { color:var(--gold); font-weight:700; font-size:0.9em; }
        select { padding:4px 10px; border-radius:10px; background:rgba(0,0,0,0.3); color:#fff; border:1px solid var(--gold); font-size:0.75em; }
        .input-row { display:flex; gap:8px; margin-bottom:6px; }
        .text-input { flex:1; padding:10px 14px; border-radius:10px; background:rgba(0,0,0,0.4); color:#fff; border:1px solid rgba(255,255,255,0.2); font-size:0.9em; outline:none; }
        .text-input:focus { border-color:var(--gold); }
        .send-btn { padding:10px 20px; border-radius:10px; background:linear-gradient(135deg,var(--gold),var(--gold-light)); color:#000; border:none; font-weight:700; cursor:pointer; }
        .transcript { background:rgba(0,0,0,0.3); padding:8px 12px; border-radius:8px; font-size:0.85em; color:rgba(255,255,255,0.8); }
        
        .stats { display:grid; grid-template-columns:repeat(5,1fr); gap:10px; padding:0 12px; margin-bottom:12px; }
        .stat { background:rgba(0,59,50,0.5); border:1px solid rgba(184,134,11,0.25); border-radius:12px; padding:14px 10px; text-align:center; cursor:pointer; transition:all 0.3s; }
        .stat:hover { background:rgba(6,95,70,0.7); transform:translateY(-2px); border-color:var(--gold); }
        .stat-val { font-size:1.5em; font-weight:800; color:var(--gold); }
        .stat-lbl { font-size:0.65em; color:rgba(255,255,255,0.7); margin-top:3px; }
        
        .content { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; padding:0 12px; margin-bottom:12px; }
        .section { background:rgba(0,59,50,0.5); border:1px solid rgba(184,134,11,0.25); border-radius:12px; padding:12px; }
        .section-head { display:flex; align-items:center; justify-content:space-between; padding-bottom:10px; border-bottom:1px solid rgba(184,134,11,0.25); margin-bottom:10px; }
        .section-title { color:var(--gold); font-weight:700; font-size:0.85em; }
        .section-badge { font-size:0.55em; padding:2px 6px; background:rgba(16,185,129,0.2); color:var(--success); border-radius:6px; }
        .list { max-height:200px; overflow-y:auto; }
        .list::-webkit-scrollbar { width:4px; }
        .list::-webkit-scrollbar-thumb { background:var(--gold); border-radius:2px; }
        
        .item { padding:8px 10px; border-radius:6px; margin-bottom:5px; background:rgba(0,0,0,0.2); transition:background 0.2s; }
        .item:hover { background:rgba(184,134,11,0.1); }
        .item.new { animation: highlight 2s ease-out; }
        @keyframes highlight { 0% { background:rgba(16,185,129,0.4); } 100% { background:rgba(0,0,0,0.2); } }
        .item-title { font-size:0.8em; color:var(--gold-light); font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .item-meta { font-size:0.65em; color:rgba(255,255,255,0.5); }
        
        .tables-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; max-height:200px; overflow-y:auto; }
        .tbl { background:rgba(0,0,0,0.25); border-radius:8px; padding:10px 6px; text-align:center; cursor:pointer; transition:all 0.2s; }
        .tbl:hover { background:rgba(184,134,11,0.15); }
        .tbl-icon { font-size:1.4em; margin-bottom:4px; }
        .tbl-name { font-size:0.55em; color:rgba(255,255,255,0.7); }
        .tbl-count { font-size:0.6em; color:var(--success); font-weight:700; }
        
        .bottom { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; padding:0 12px 20px; }
        
        @media (max-width:1100px) { .content,.bottom { grid-template-columns:1fr 1fr; } }
        @media (max-width:700px) { .stats { grid-template-columns:repeat(2,1fr); } .content,.bottom { grid-template-columns:1fr; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-area">
            <div class="logo">ğŸ </div>
            <div class="brand">
                <h1>Vista<span>View</span> Agentic AI v32</h1>
                <p>World's First Real Estate Intelligence Platform</p>
            </div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
            <div class="status"><div class="dot"></div>Learning Active</div>
            <span id="clock" style="font-size:0.8em;color:rgba(255,255,255,0.7);">--:--:--</span>
        </div>
    </header>
    
    <div class="voice-bar">
        <button class="mic" id="mic" onclick="toggleMic()">ğŸ¤</button>
        <div class="voice-content">
            <div class="voice-head">
                <span class="voice-title">ğŸ™ï¸ Voice Input</span>
                <select id="userType">
                    <option value="boss">ğŸ‘¤ Boss</option>
                    <option value="dev_team">ğŸ‘¥ Dev Team</option>
                    <option value="vendor">ğŸª Vendor</option>
                </select>
            </div>
            <div class="input-row">
                <input type="text" class="text-input" id="textInput" placeholder="Type or speak..." onkeypress="if(event.key==='Enter')sendText()">
                <button class="send-btn" onclick="sendText()">Send</button>
            </div>
            <div class="transcript" id="transcript">Ready...</div>
        </div>
    </div>
    
    <div class="stats">
        <div class="stat"><div class="stat-val" id="sLedger">0</div><div class="stat-lbl">ğŸ“Š Ledger</div></div>
        <div class="stat"><div class="stat-val" id="sBoss">0</div><div class="stat-lbl">ğŸ‘¤ Boss</div></div>
        <div class="stat"><div class="stat-val" id="sTeam">0</div><div class="stat-lbl">ğŸ‘¥ Team</div></div>
        <div class="stat"><div class="stat-val" id="sPatterns">0</div><div class="stat-lbl">ğŸ§  Patterns</div></div>
        <div class="stat"><div class="stat-val" id="sCrawled">0</div><div class="stat-lbl">ğŸŒ Crawled</div></div>
    </div>
    <div class="stats">
        <div class="stat"><div class="stat-val" id="sProducts">0</div><div class="stat-lbl">ğŸ“¦ Products</div></div>
        <div class="stat"><div class="stat-val" id="sTTS">0</div><div class="stat-lbl">ğŸ”Š TTS</div></div>
        <div class="stat"><div class="stat-val" id="sSessions">0</div><div class="stat-lbl">ğŸ‘¥ Sessions</div></div>
        <div class="stat"><div class="stat-val" id="sAudit">0</div><div class="stat-lbl">ğŸ“œ Audit</div></div>
        <div class="stat"><div class="stat-val" id="sAccuracy">0%</div><div class="stat-lbl">ğŸ¯ Accuracy</div></div>
    </div>
    
    <div class="content">
        <div class="section">
            <div class="section-head"><span class="section-title">ğŸ“¡ Live Feed</span><span class="section-badge">Real-time</span></div>
            <div class="list" id="feed"></div>
        </div>
        <div class="section">
            <div class="section-head"><span class="section-title">ğŸ“Š Database Tables</span></div>
            <div class="tables-grid" id="tables"></div>
        </div>
        <div class="section">
            <div class="section-head"><span class="section-title">ğŸŒ Crawled Sites</span></div>
            <div class="list" id="crawled"></div>
        </div>
    </div>
    
    <div class="bottom">
        <div class="section">
            <div class="section-head"><span class="section-title">ğŸ§  Patterns</span><span class="section-badge" id="patternCount">0</span></div>
            <div class="list" id="patterns"></div>
        </div>
        <div class="section">
            <div class="section-head"><span class="section-title">ğŸ¤ Voice Commands</span><span class="section-badge" id="cmdCount">0</span></div>
            <div class="list" id="commands"></div>
        </div>
        <div class="section">
            <div class="section-head"><span class="section-title">ğŸ’š Empathy</span><span class="section-badge" id="empathyCount">0</span></div>
            <div class="list" id="empathy"></div>
        </div>
        <div class="section">
            <div class="section-head"><span class="section-title">ğŸ‘¤ Boss Inputs</span><span class="section-badge" id="bossCount">0</span></div>
            <div class="list" id="bossInputs"></div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:1117/api';
        let isRec = false, recog = null;
        let lastBossId = 0;
        
        const icons = {
            ai_memories:'ğŸ§ ', crawled_voice_patterns:'ğŸŒ', voice_patterns:'ğŸ¤', knowledge_base:'ğŸ“š',
            tts_responses:'ğŸ”Š', realtime_feed:'ğŸ“¡', crawled_sources:'ğŸ”', empathy_learning:'ğŸ’š',
            voice_command_learning:'ğŸ—£ï¸', boss_voice_inputs:'ğŸ‘”', global_interaction_ledger:'ğŸ“Š',
            learning_stats:'ğŸ“ˆ', learned_patterns:'ğŸ§¬', catalog_items:'ğŸ“¦', listings:'ğŸ '
        };
        
        setInterval(() => document.getElementById('clock').textContent = new Date().toLocaleTimeString(), 1000);
        
        if ('webkitSpeechRecognition' in window) {
            recog = new webkitSpeechRecognition();
            recog.continuous = true;
            recog.interimResults = true;
            recog.onresult = (e) => {
                let final = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    if (e.results[i].isFinal) final += e.results[i][0].transcript;
                }
                if (final) { document.getElementById('textInput').value = final; sendInput(final); }
            };
            recog.onend = () => { if (isRec) recog.start(); };
        }
        
        function toggleMic() {
            if (isRec) { recog?.stop(); isRec = false; document.getElementById('mic').classList.remove('on'); document.getElementById('mic').textContent = 'ğŸ¤'; }
            else { recog?.start(); isRec = true; document.getElementById('mic').classList.add('on'); document.getElementById('mic').textContent = 'ğŸ”´'; document.getElementById('transcript').textContent = 'ğŸ¤ Listening...'; }
        }
        
        function sendText() {
            const t = document.getElementById('textInput').value.trim();
            if (t) { sendInput(t); document.getElementById('textInput').value = ''; }
        }
        
        async function sendInput(text) {
            document.getElementById('transcript').textContent = 'ğŸ“¤ Sending...';
            try {
                const r = await fetch(API + '/ledger/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_type: document.getElementById('userType').value, raw_transcript: text, page_route: '/dashboard' })
                });
                const d = await r.json();
                document.getElementById('transcript').textContent = 'âœ… ' + text;
                if (d.tts_response?.text && window.speechSynthesis) {
                    speechSynthesis.cancel();
                    speechSynthesis.speak(new SpeechSynthesisUtterance(d.tts_response.text));
                }
                // Immediate refresh
                setTimeout(loadAll, 100);
            } catch (e) {
                document.getElementById('transcript').textContent = 'âŒ ' + e.message;
            }
        }
        
        function fmt(n) { 
            if (n === null || n === undefined) return '0';
            n = parseInt(n) || 0;
            return n >= 1000000 ? (n/1000000).toFixed(1)+'M' : n >= 1000 ? Math.round(n/1000)+'K' : n.toString(); 
        }
        
        async function loadDash() {
            try {
                const r = await fetch(API + '/dashboard');
                const d = await r.json();
                const s = d.stats || {};
                
                document.getElementById('sLedger').textContent = fmt(s.ledger_entries || s.total_interactions);
                document.getElementById('sBoss').textContent = fmt(s.boss_inputs);
                document.getElementById('sTeam').textContent = fmt(s.team_inputs);
                document.getElementById('sPatterns').textContent = fmt(s.patterns_learned);
                document.getElementById('sCrawled').textContent = fmt(s.web_pages_crawled || s.web_crawls);
                document.getElementById('sProducts').textContent = fmt(s.products_cataloged);
                document.getElementById('sTTS').textContent = fmt(s.tts_responses_given);
                document.getElementById('sSessions').textContent = fmt(s.active_sessions || 1);
                document.getElementById('sAudit').textContent = fmt(s.audit_entries);
                document.getElementById('sAccuracy').textContent = (parseFloat(s.accuracy_score) || 85).toFixed(1) + '%';
                
                if (d.tables?.length) {
                    document.getElementById('tables').innerHTML = d.tables.slice(0, 12).map(t => 
                        `<div class="tbl"><div class="tbl-icon">${icons[t.name] || 'ğŸ“‹'}</div><div class="tbl-name">${t.name.replace(/_/g,' ')}</div><div class="tbl-count">${t.count}</div></div>`
                    ).join('');
                }
            } catch (e) { console.error('Dashboard:', e); }
        }
        
        async function loadFeed() {
            try {
                const r = await fetch(API + '/feed');
                const d = await r.json();
                document.getElementById('feed').innerHTML = d.length ? d.slice(0, 10).map(f => 
                    `<div class="item"><div class="item-title">${f.title || f.feed_type || 'Event'}</div><div class="item-meta">${f.description || ''}</div></div>`
                ).join('') : '<div class="item"><div class="item-meta">Waiting...</div></div>';
            } catch (e) {}
        }
        
        async function loadCrawled() {
            try {
                const r = await fetch(API + '/crawled-sites');
                const d = await r.json();
                document.getElementById('crawled').innerHTML = d.length ? d.slice(0, 10).map(s => 
                    `<div class="item"><div class="item-title">${s.domain}</div><div class="item-meta">${fmt(s.pages_crawled)} pages</div></div>`
                ).join('') : '<div class="item"><div class="item-meta">No sites</div></div>';
            } catch (e) {}
        }
        
        async function loadPatterns() {
            try {
                const r = await fetch(API + '/patterns');
                const d = await r.json();
                document.getElementById('patternCount').textContent = d.length;
                document.getElementById('patterns').innerHTML = d.length ? d.slice(0, 8).map(p => 
                    `<div class="item"><div class="item-title">${p.pattern_name || p.pattern_text?.substring(0,30) || 'Pattern'}</div><div class="item-meta">${p.occurrence_count || 1}x â€¢ ${p.pattern_type || 'general'}</div></div>`
                ).join('') : '<div class="item"><div class="item-meta">No patterns yet</div></div>';
            } catch (e) { console.error('Patterns:', e); }
        }
        
        async function loadCommands() {
            try {
                const r = await fetch(API + '/voice-commands');
                const d = await r.json();
                document.getElementById('cmdCount').textContent = d.length;
                document.getElementById('commands').innerHTML = d.length ? d.slice(0, 8).map(c => 
                    `<div class="item"><div class="item-title">${c.command_text}</div><div class="item-meta">${c.times_used || 0}x â€¢ ${Math.round((c.success_rate || 0) * 100)}%</div></div>`
                ).join('') : '<div class="item"><div class="item-meta">No commands yet</div></div>';
            } catch (e) { console.error('Commands:', e); }
        }
        
        async function loadEmpathy() {
            try {
                const r = await fetch(API + '/empathy-patterns');
                const d = await r.json();
                document.getElementById('empathyCount').textContent = d.length;
                document.getElementById('empathy').innerHTML = d.length ? d.slice(0, 8).map(e => 
                    `<div class="item"><div class="item-title" style="color:#10b981">${e.emotion_detected}</div><div class="item-meta">${e.times_used || 0}x â€¢ ${Math.round((e.effectiveness_score || 0) * 100)}%</div></div>`
                ).join('') : '<div class="item"><div class="item-meta">No empathy data</div></div>';
            } catch (e) { console.error('Empathy:', e); }
        }
        
        async function loadBossInputs() {
            try {
                const r = await fetch(API + '/boss-inputs');
                const d = await r.json();
                document.getElementById('bossCount').textContent = d.length;
                
                // Check for new items
                const newId = d[0]?.id || 0;
                const isNew = newId > lastBossId;
                lastBossId = newId;
                
                document.getElementById('bossInputs').innerHTML = d.length ? d.slice(0, 8).map((b, i) => 
                    `<div class="item ${i === 0 && isNew ? 'new' : ''}"><div class="item-title">${(b.raw_text || '').substring(0, 35)}</div><div class="item-meta">${new Date(b.created_at).toLocaleTimeString()}</div></div>`
                ).join('') : '<div class="item"><div class="item-meta">No boss inputs</div></div>';
            } catch (e) { console.error('Boss:', e); }
        }
        
        function loadAll() {
            loadDash();
            loadFeed();
            loadCrawled();
            loadPatterns();
            loadCommands();
            loadEmpathy();
            loadBossInputs();
        }
        
        loadAll();
        setInterval(loadAll, 1500); // Refresh every 1.5 seconds
    </script>
</body>
</html>
